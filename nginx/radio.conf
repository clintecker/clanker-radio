# Upstream definition for Icecast server
# Allows for easier configuration and potential future load balancing
upstream icecast_server {
    server 127.0.0.1:8000;
    keepalive 8;
}

# Upstream definition for Liquidsoap Harbor HTTP API
upstream liquidsoap_api {
    server 127.0.0.1:8081;
    keepalive 4;
}

server {
    listen 80;
    server_name your-radio-domain.com;

    # TCP optimizations for low-latency streaming
    tcp_nodelay on;  # Disable Nagle's algorithm - send data immediately
    tcp_nopush on;   # Optimize packet sending

    # Logging
    access_log /var/log/nginx/radio_access.log;
    error_log /var/log/nginx/radio_error.log;

    # Proxy Icecast stream - OPTIMIZED FOR LONG-LIVED MP3 STREAMING
    location /radio {
        # === CRITICAL STREAMING SETTINGS ===
        # Disable response buffering - must pass audio data immediately, not buffer entire stream
        proxy_buffering off;

        # Disable request buffering for consistency
        proxy_request_buffering off;

        # === CONNECTION HANDLING ===
        # Use HTTP/1.1 for keepalive support
        proxy_http_version 1.1;

        # Clear Connection header to allow keepalive to upstream
        proxy_set_header Connection "";

        # === HEADERS ===
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CRITICAL: Prevent gzip compression of already-compressed MP3 stream
        # This saves CPU and prevents potential stream corruption
        proxy_set_header Accept-Encoding "";

        # === TIMEOUTS FOR LONG-LIVED CONNECTIONS ===
        # Allow 15 minutes of inactivity from upstream before closing
        # Handles potential stream pauses or metadata-only packets
        proxy_read_timeout 900s;

        # Allow 15 minutes for slow clients before disconnecting
        # Prevents dropping listeners with poor network conditions
        send_timeout 900s;

        # === PROXY TARGET ===
        proxy_pass http://icecast_server;

        # === CORS HEADERS ===
        add_header Access-Control-Allow-Origin *;
    }

    # Proxy Icecast status (source of truth for what's currently playing)
    location /api/icecast_status.json {
        proxy_pass http://icecast_server/status-json.xsl;

        # CORS headers
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS';

        # Short cache (2 seconds) - Icecast updates frequently
        add_header Cache-Control 'public, max-age=2';

        # Content type
        default_type application/json;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # Landing page
    location / {
        root /srv/ai_radio/public;
        index index.html;
        try_files $uri $uri/ =404;
    }

    # =========================================================================
    # ADMIN SECTION - Protected by HTTP Basic Auth
    # =========================================================================

    # Icecast admin interface
    location /admin/icecast/ {
        auth_basic "Radio Admin";
        auth_basic_user_file /etc/nginx/.htpasswd;

        # Proxy to Icecast admin
        proxy_pass http://icecast_server/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Liquidsoap Harbor HTTP API
    location /admin/liquidsoap/ {
        auth_basic "Radio Admin";
        auth_basic_user_file /etc/nginx/.htpasswd;

        # Proxy to Liquidsoap Harbor API
        proxy_pass http://liquidsoap_api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Admin section landing
    location = /admin {
        return 301 /admin/;
    }

    location /admin/ {
        auth_basic "Radio Admin";
        auth_basic_user_file /etc/nginx/.htpasswd;
        alias /srv/ai_radio/public/admin/;
        index index.html;
        try_files $uri $uri/ =404;
    }
}
