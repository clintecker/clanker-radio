#!/usr/bin/env python3
"""Rename Malware Groove tracks with unique hex identifiers.

Updates both database titles and ID3 tags in MP3 files.
"""
import argparse
import random
import sqlite3
import sys
from pathlib import Path

from mutagen.mp3 import MP3
from mutagen.id3 import TIT2


def generate_unique_hex(existing: set) -> str:
    """Generate unique 4-digit hex identifier."""
    while True:
        hex_id = f"0x{random.randint(0x1000, 0xFFFF):04X}"
        if hex_id not in existing:
            existing.add(hex_id)
            return hex_id


def main():
    """Rename all Malware Groove tracks."""
    parser = argparse.ArgumentParser(description="Rename Malware Groove tracks with unique hex IDs")
    parser.add_argument("--yes", "-y", action="store_true", help="Skip confirmation prompt")
    args = parser.parse_args()

    # Use hardcoded path since config requires dependencies
    db_path = Path("/srv/ai_radio/db/radio.sqlite3")

    print(f"Connecting to database: {db_path}")
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()

    # Get all Malware Groove tracks
    cursor.execute("""
        SELECT id, path, title
        FROM assets
        WHERE title = 'Malware Groove'
        ORDER BY path
    """)

    tracks = cursor.fetchall()
    print(f"\nFound {len(tracks)} Malware Groove tracks")

    if not tracks:
        print("No tracks to rename")
        return

    # Generate unique hex IDs
    used_hexes = set()
    updates = []

    for asset_id, path, title in tracks:
        hex_id = generate_unique_hex(used_hexes)
        new_title = f"Malware Groove ({hex_id})"
        updates.append((asset_id, path, new_title))

    # Show preview
    print("\nPreview of changes:")
    for asset_id, path, new_title in updates[:5]:
        print(f"  {Path(path).name[:40]:40} -> {new_title}")
    if len(updates) > 5:
        print(f"  ... and {len(updates) - 5} more")

    # Confirm
    if not args.yes:
        response = input("\nProceed with renaming? (yes/no): ")
        if response.lower() != 'yes':
            print("Aborted")
            return

    # Update database and ID3 tags
    print("\nUpdating...")
    success_count = 0

    for asset_id, path, new_title in updates:
        try:
            # Update database
            cursor.execute(
                "UPDATE assets SET title = ? WHERE id = ?",
                (new_title, asset_id)
            )

            # Update ID3 tags
            audio = MP3(path)
            audio.tags['TIT2'] = TIT2(encoding=3, text=new_title)
            audio.save()

            success_count += 1
            print(f"  ✓ {new_title}")

        except Exception as e:
            print(f"  ✗ Failed to update {path}: {e}")

    # Commit database changes
    conn.commit()
    conn.close()

    print(f"\n✅ Successfully renamed {success_count}/{len(updates)} tracks")


if __name__ == "__main__":
    main()
